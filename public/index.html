<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <title>Vraid Systems LLC - ml_trader</title>
</head>

<body>
    <div id="dashboard_div">
        <div id="filter_div"></div>
        <div id="chart_div"></div>
    </div>

    <div id="fetch-status"></div>

    <script type="text/javascript">
        google.charts.load('current', {'packages': ['corechart', 'controls']})

        google.charts.setOnLoadCallback(() => {
            fetch('/predictions', {
                cache: 'no-cache',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                },
                method: 'GET',
                mode: 'no-cors',
                redirect: 'follow',
                referrerPolicy: 'no-referrer',
            }).then(
                response => response.json()
            ).then(predictions => {
                const dataRows = []
                for (const [ticker, tickerModelRuns] of Object.entries(predictions)) {
                    for (const [modelRunName, timePriceTuples] of Object.entries(tickerModelRuns)) {
                        timePriceTuples.forEach(timePriceTuple => {
                            dataRows.push([
                                new Date(timePriceTuple[0]),
                                Number.parseFloat(timePriceTuple[1]),
                                `${ticker}-${modelRunName}`,
                            ])
                        })
                    }
                }

                renderDashboard(dataRows)
            }).catch((error) => {
                document.getElementById('fetch-status').innerHTML = error
            })
        })

        const renderDashboard = (dataRows) => {
            const dashboard = new google.visualization.Dashboard(document.getElementById('dashboard_div'))

            const controlWrapper = new google.visualization.ControlWrapper({
                containerId: 'filter_div',
                controlType: 'CategoryFilter',
                options: {
                    filterColumnIndex: 2,
                },
            })

            const chartWrapper = new google.visualization.ChartWrapper({
                chartType: 'ScatterChart',
                containerId: 'chart_div',
                options: {
                    hAxis: {
                        title: 'Time',
                    },
                    height: 1024,
                    legend: 'none',
                    title: '',
                    vAxis: {
                        title: 'Asset Price',
                    },
                    width: 1024,
                },
            })

            dashboard.bind(controlWrapper, chartWrapper)

            const dataTable = new google.visualization.DataTable()
            dataTable.addColumn({id: 'Time', type: 'date'})
            dataTable.addColumn({id: 'Asset Price', type: 'number'})
            dataTable.addColumn({id: 'Model Run', role: 'tooltip', type: 'string'})
            dataTable.addRows(dataRows)
            dashboard.draw(dataTable)
        }
    </script>
</body>
</html>
